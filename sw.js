(()=>{const e="MuXiaoChenCache",t="https://id.v3/",n=()=>caches.match(t).then((e=>e?.json())),s=n=>caches.open(e).then((e=>e.put(t,new Response(JSON.stringify(n)))));self.addEventListener("install",(()=>{self.skipWaiting();n().then((async t=>{if(t&&13!==t.escape){const t=await caches.open(e).then((e=>e.keys())).then((e=>e?.map((e=>e.url))));await caches.delete(e);const n=await m();n.type="escape",n.list=t;(await clients.matchAll()).forEach((e=>e.postMessage(n)))}}))})),self.addEventListener("activate",(e=>e.waitUntil(clients.claim())));const a=(e,t,n,s)=>(s||(s={}),s.cache=t?"no-store":"default",n&&(s.mode="cors",s.credentials="same-origin"),fetch(e,s)),c=(e,t,n)=>a(e,t,!0,n),r=e=>{if("localhost"!==e.hostname)for(let t in i){const n=i[t];if(n.match(e))return n}};let i={simple:{clean:!0,search:!1,match:e=>"www.aimiliy.top"===e.host&&["/404.html","/css/index.css"].includes(e.pathname)},cdn:{clean:!0,match:e=>["www.aimiliy.top","cdn.aimiliy.top","cdn.cbd.int","lf26-cdn-tos.bytecdntp.com","lf6-cdn-tos.bytecdntp.com","lf3-cdn-tos.bytecdntp.com","lf9-cdn-tos.bytecdntp.com","cdn.staticfile.org","npm.elemecdn.com"].includes(e.host)&&e.pathname.match(/\.(js|css|woff2|woff|ttf|cur)$/)}},o=e=>{if(e.startsWith("https://npm.elemecdn.com"))return{timeout:3e3,list:[e,`https://cdn.cbd.int/${new URL(e).pathname}`]}},l=()=>!1;const h=(e,t,n=null)=>{if(!n&&!(n=o(e.url)))return c(e,t);const s=n.list,a=new Array(s.length),r=n=>c(new Request(s[n],e),t,{signal:(a[n]=new AbortController).signal}).then((e=>u(e)?{r:e,i:n}:Promise.reject()));return new Promise(((t,c)=>{let i=!0;const o=()=>{i=!1,Promise.any([h,...Array.from({length:s.length-1},((e,t)=>t+1)).map((e=>r(e)))]).then((e=>{for(let t=0;t!==s.length;++t)t!==e.i&&a[t].abort();t(e.r)})).catch((()=>c(`请求 ${e.url} 失败`)))},l=setTimeout(o,n.timeout),h=r(0).then((e=>{i&&(clearTimeout(l),t(e.r))})).catch((()=>(i&&(clearTimeout(l),o()),Promise.reject())))}))},u=e=>e.ok||[301,302,307,308].includes(e.status),f=new Map;self.addEventListener("fetch",(t=>{let n=t.request,s=new URL(n.url);if("GET"!==n.method||!n.url.startsWith("http"))return;if((e=>{const t=e.url;return!!(t.startsWith("https://i0.hdslb.com")||t.startsWith("http")||["/archives/","/tags/","/categories/","/life/music/","/life/movies/","/life/games/","/life/bangumi/","/box/gallery/","/box/animation/","/box/nav/","/social/fcircle/","/comments/","/social/link/","/site/census/","/site/echarts/","/site/time/","/personal/bb/","/personal/love/","/personal/about/"].some((e=>t.includes(e))))})(n))return;let c,i=s.hostname+s.pathname+s.search;const m=e=>{t.respondWith(c?e.then((e=>{for(let t of c)t(e.clone())})).catch((e=>{for(let t of c)t(e)})).then((()=>(f.delete(i),e))):e)},p=r(s);if(p){let t=`https://${s.host}${s.pathname}`;t.endsWith("/index.html")&&(t=t.substring(0,t.length-10)),p.search&&(t+=s.search),m(caches.match(t).then((s=>s??h(n,!0).then((n=>{if(u(n)){const s=n.clone();caches.open(e).then((e=>e.put(t,s)))}return n})))))}else{const e=o(n.url);m(e?h(n,!1,e):((e,t)=>a(e,!1,l(e),t))(n).catch((e=>new Response(e,{status:499}))))}})),self.addEventListener("message",(e=>{"update"===e.data&&m().then((t=>{t.type="update",e.source.postMessage(t)}))}));const m=async()=>{const a=await h(new Request("/update.json"),!1);if(!u(a))throw`加载 update.json 时遇到异常，状态码：${a.status}`;const c=await a.json(),r=await(e=>n().then((t=>{const{info:n,global:a}=e,c={global:a,local:n[0].version,escape:t?.escape??0};if(!t)return c.escape=13,s(c),{new:c,old:t};let r=new p,i=((e,t,n)=>{for(let s of t){const{version:t,change:a}=s;if(t===n)return!1;if(a)for(let t of a)e.push(new d(t))}return!0})(r,n,t.local);return s(c),i&&(a!==t.global?r.force=!0:r.refresh=!0),{list:r,new:c,old:t}})))(c);if(r.list){const n=await(n=>caches.open(e).then((e=>e.keys().then((s=>Promise.all(s.map((async s=>{const a=s.url;return a!==t&&n.match(a)?(e.delete(s),a):null}))))).then((e=>e.filter((e=>e)))))))(r.list);r.list=n?.length?n:null}return r};function p(){const e=[];this.push=t=>{e.push(t)},this.match=t=>{if(this.force)return!0;if(t=new URL(t),this.refresh)return r(t).clean;for(let n of e)if(n.match(t))return!0;return!1}}function d(e){const t=t=>{const n=e.value;if(Array.isArray(n)){for(let e of n)if(t(e))return!0;return!1}return t(n)};this.match=(()=>{switch(e.flag){case"html":return e=>e.pathname.match(/(\/|\.html)$/);case"end":return e=>t((t=>e.href.endsWith(t)));case"begin":return e=>t((t=>e.pathname.startsWith(t)));case"str":return e=>t((t=>e.href.includes(t)));case"reg":return e=>t((t=>e.href.match(new RegExp(t,"i"))));default:throw`未知表达式：${JSON.stringify(e)}`}})()}})();