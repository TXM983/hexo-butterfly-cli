document.addEventListener("DOMContentLoaded",(function(){const e={formatDateTime:e=>{const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")}`},umiToken:"fM7+vUSp/wpEp/mp0LxXrjS46tMQWimFhssZdUuj2SADnmGfHo5rZMOh4PpYSumeLcUNt4a2+q0TNW6VH5vymKH3YFxPNxOm28yjdAAHD/Tew66V/8Ad/K9dXxULUuMWaSL2hUS2zTGIZWipOYUHzkjRFwShDAYQwfbgOGrmgW/P36qqr9FaZaKt9LYVkbY9hQKQ4tRTlhc8zFgwIn/q3Rw/ot7G0HVprAk3PwBkEdyDfPQd7kchi/f+g1g+1X856/v0O7GirvBeQQ7TPhi4/H0/kNm+ZABPDk6+VomlMNnYdZi1KiW90SfTOcUDlvObyKUbCsQpl/LMiDeAtby+0pzkqaSLSpsr7Y5eoR4pDP4Wt+RaZkkHjawJfYjc",fetchUmami:async(e,t,n)=>{try{if(!e||!t||!n)throw new Error("参数 startAt、endAt 或 umiToken 不完整");const a=new URL("https://umami.aimiliy.top/api/websites/3348d0ad-813b-4d17-98d2-d5404445f786/stats");a.searchParams.append("startAt",e.getTime()),a.searchParams.append("endAt",t.getTime());const s=await fetch(a.toString(),{method:"GET",cache:"default",headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"}});if(!s.ok)throw new Error(`请求失败，状态码：${s.status} ${s.statusText}`);return await s.json()}catch(e){throw console.error("获取 umami 统计数据失败：",e.message),e}},removeAllHtmlTags:e=>`“${e.replace(/<[^>]+>.*?<\/[^>]+>|<[^>]+\/>|<[^>]+>/gis,"").trim()}”`,removeAllHtmlTagsNoMark:e=>`${e.replace(/<[^>]+>.*?<\/[^>]+>|<[^>]+\/>|<[^>]+>/gis,"").trim()}`,contentFormat:e=>{let t="<br>";const n=[...e.matchAll(/<video.*?src=["'](.*?)["'].*?>.*?<\/video>/gi)];n.length>0&&n.forEach((n=>{const a=n[1];let s="";if(a.includes("bilibili.com/video/")){const e=a.match(/\/video\/(BV\w+)/);e&&(s=`\n                              <div style="position: relative; padding: 30% 45%; margin-top: 10px; margin-bottom: 10px;">\n                                <div class="iframe-loader" data-src="https://www.bilibili.com/blackboard/html5mobileplayer.html?bvid=${e[1]}&as_wide=1&high_quality=1&danmaku=0">\n                                  <div class="loading-spinner glow"></div>\n                                </div>\n                              </div>`)}else s=`\n                          <a class="bber-content-video" href="${a}" data-fancybox="gallery" data-caption="">\n                            <video src="${a}" controls style="max-width: 100%; border-radius: 10px; margin-top: 10px;"></video>\n                          </a>`;t+=s,e=e.replace(n[0],"")}));let a=e.match(/(http(.*).[jpg|png|gif])/g);return e=(e=e.replace(/<img(.*?)src=[\"|\']?(.*?)[\"|\']?(.*?)>|!\[(.*?)\]\((.*?)\)/g,"")).replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),a&&a.forEach((e=>{t+='<a href="'+e+'" target="_blank" data-fancybox="group" class="fancybox"><img src="'+e+'" style="max-width: 100%; object-fit: cover; border-radius: 10px;margin-top: 10px"></a>'})),(e+=t).replace(/(<br\s*\/?>)+$/,"")}},t=(()=>{const e=e=>e*Math.PI/180,t=(t,n=!1)=>{const a=document.getElementById("welcome-info");if(n)a.innerHTML='\n                    <div style="text-align: center;"><b>🎉 欢迎信息 🎉</b></div>\n                    <b>\n                        <span style="padding:10px;display: flex;justify-content: center;align-items: center;">\n                            &emsp;&emsp;网络有点卡呢，正在努力获取您的位置信息中！(っ•̀ω•́)っ✧🚀📡\n                        </span>\n                    </b>';else try{const{ad_info:n,location:s,ip:o}=t.result,{nation:r,province:i,city:l,district:c}=n,d=i?`${i} ${l} ${c}`:r,u=((t,n,a,s)=>{const o=e(s-n),r=e(a-t),i=Math.sin(o/2)**2+Math.cos(e(n))*Math.cos(e(s))*Math.sin(r/2)**2,l=2*Math.asin(Math.sqrt(i));return Math.round(6371*l)})(114.34253,30.49984,s.lng,s.lat),m=((e,t,n)=>{const a={"日本":"よろしく，一起去看樱花吗","美国":"Let us live in peace!","英国":"想同你一起夜乘伦敦眼","俄罗斯":"干了这瓶伏特加！","法国":"C'est La Vie","德国":"Die Zeit verging im Fluge.","澳大利亚":"一起去大堡礁吧！","加拿大":"拾起一片枫叶赠予你","中国":{"北京市":"北——京——欢迎你~~~","天津市":"讲段相声吧。","河北省":"山势巍巍成壁垒，天下雄关...","山西省":"展开坐具长三尺，已占山河五百余。","内蒙古自治区":"天苍苍，野茫茫，风吹草低见牛羊。","辽宁省":"我想吃烤鸡架！","吉林省":"状元阁就是东北烧烤之王。","黑龙江省":"很喜欢哈尔滨大剧院。","上海市":"众所周知，中国只有两个城市。","江苏省":{"南京市":"这是我挺想去的城市啦。","苏州市":"上有天堂，下有苏杭。",default:"散装是必须要散装的。"},"浙江省":"东风渐绿西湖柳，雁已还人未南归。","河南省":{"郑州市":"豫州之域，天地之中。","南阳市":"臣本布衣，躬耕于南阳。此南阳非彼南阳！","驻马店市":"峰峰有奇石，石石挟仙气。嵖岈山的花很美哦！",default:"可否带我品尝河南烩面啦？"},"安徽省":"蚌埠住了，芜湖起飞。","福建省":"井邑白云间，岩城远带山。","江西省":"落霞与孤鹜齐飞，秋水共长天一色。","山东省":"遥望齐州九点烟，一泓海水杯中泻。","湖北省":"来碗热干面！","湖南省":"74751，长沙斯塔克。","广东省":"老板来两斤福建人。","广西壮族自治区":"桂林山水甲天下。","海南省":"朝观日出逐白浪，夕看云起收霞光。","四川省":"康康川妹子。","贵州省":"茅台，学生，再塞200。","云南省":"玉龙飞舞云缠绕，万仞冰川直耸天。","西藏自治区":"躺在茫茫草原上，仰望蓝天。","陕西省":"来份臊子面加馍。","甘肃省":"羌笛何须怨杨柳，春风不度玉门关。","青海省":"牛肉干和老酸奶都好好吃。","宁夏回族自治区":"大漠孤烟直，长河落日圆。","新疆维吾尔自治区":"驼铃古道丝绸路，胡马犹闻唐汉风。","台湾省":"我在这头，大陆在那头。","香港特别行政区":"永定贼有残留地鬼嚎，迎击光非岁玉。","澳门特别行政区":"性感荷官，在线发牌。",default:"带我去你的城市逛逛吧！"},default:"带我去你的国家逛逛吧。"};return"中国"===e&&a[e]&&a[e][t]?"object"==typeof a[e][t]?a[e][t][n]?a[e][t][n]:a[e][t].default||"咦，这里好像还没被标注哎！":a[e][t]:a[e]?a[e]:a.default})(r,i,l),p=(()=>{const e=(new Date).getHours();return e>=5&&e<11?"<span>早上好</span>，今天也要元气满满呀！":e>=11&&e<13?"<span>中午好</span>，先放下工作吃顿好的吧～":e>=13&&e<15?"<span>下午好</span>，小憩一会儿，别太累了哦。":e>=15&&e<16?"<span>茶点时间</span>到啦！来杯奶茶提提神～":e>=16&&e<19?"<span>傍晚好</span>，夕阳正美，记得休息眼睛。":e>=19&&e<24?"<span>晚上好</span>，今天也辛苦啦，放松一下吧～":"<span>夜深了</span>，早点休息，别再刷手机啦～"})();a.innerHTML=`\n                    <div style="text-align: center;"><b>🎉 欢迎信息 🎉</b></div>\n                    <b>&emsp;&emsp;欢迎来自 \n                        <span style="color:var(--theme-color)">${d}</span> 的小伙伴，${p}\n                        您现在距离站长约 \n                        <span style="color:var(--theme-color)">${u}</span> 公里，\n                        当前的IP地址为： \n                        <span class="blur-ip">${o}</span>， \n                        ${m}\n                    </b>`}catch(e){console.error("地理位置信息加载失败：",e),a.innerHTML='<div style="text-align: center;"><b>🎉 欢迎信息 🎉</b></div>\n                    <b>\n                        <span style="padding:10px;display: flex;justify-content: center;align-items: center;">\n                            &emsp;&emsp;地理位置信息加载失败，迷路啦！🧭😵\n                        </span>\n                    </b>'}};return{init:async()=>{if(!/^\/(?:page\/\d+\/|)$/.test(window.location.pathname))return;const e=(()=>{const e=localStorage.getItem("ipLocation");if(!e)return null;try{const t=JSON.parse(e),n=t.locationTime,a=Date.now();if(n&&a-n<18e5)return t}catch(e){console.warn("缓存解析失败",e)}return null})();if(e)t(e);else{t(null,!0);try{const e=await new Promise(((e,t)=>{const n="jsonp_callback_"+Date.now(),a=setTimeout((()=>{t(new Error("请求超时")),s()}),5e3),s=()=>{delete window[n],o.remove(),clearTimeout(a)};window[n]=t=>{e(t),s()};const o=document.createElement("script");o.src=`https://apis.map.qq.com/ws/location/v1/ip?key=UEVBZ-KBWCW-L67R2-YZ7NC-CYZY3-LKFR5&output=jsonp&callback=${n}`,o.onerror=e=>{t(e),s()},document.head.appendChild(o)}));(e=>{const t={result:{ad_info:e.result.ad_info,location:e.result.location,ip:e.result.ip},locationTime:Date.now()};localStorage.setItem("ipLocation",JSON.stringify(t))})(e),t(e)}catch(e){console.error("Location fetch failed:",e),document.getElementById("welcome-info").innerHTML='<div style="text-align: center;"><b>🎉 欢迎信息 🎉</b></div>\n                        <b>\n                            <span style="padding:10px;display: flex;justify-content: center;align-items: center;">\n                                &emsp;&emsp;地理位置信息加载失败！\n                            </span>\n                        </b>'}}}}})(),n=(()=>{const e=(e,t)=>{if(t.has(e))return t.get(e);const n=e.match(/rgb\((\d+), (\d+), (\d+)\)/);if(!n)throw new Error("Invalid RGB string format");const[a,s,o,r]=n,i=`#${Math.min(parseInt(s,10)+40,255).toString(16).padStart(2,"0")}${Math.min(parseInt(o,10)+40,255).toString(16).padStart(2,"0")}${Math.min(parseInt(r,10)+40,255).toString(16).padStart(2,"0")}`;return t.set(e,i),i};return{init:()=>{const t={defaultMusic:{id:"7397995017",type:"playlist",server:"tencent"},canvas:document.getElementById("visualizer"),visualizer:{fftSize:256,smoothing:.9,shadowBlur:15},cache:new Map},n={canvas:t.canvas,ctx:t.canvas.getContext("2d"),anMusicBg:document.getElementById("an_music_bg"),anMusicPage:document.getElementById("anMusic-page"),page:document.getElementById("page"),menuMask:document.getElementById("menu-mask")};let a,s,o,r,i,l,c,d,u=.8,m=null,p=null,g=localStorage.getItem("themeColor"),h=e(btf.map.get(g),t.cache);const f=(e=!0)=>{const t=e=>{if(!e)return;n.anMusicBg.style.backgroundImage=e.style.backgroundImage;let t=e.querySelector("div.child");t||(t=document.createElement("div"),t.classList.add("child"),e.appendChild(t)),t.style.backgroundImage=e.style.backgroundImage},a=()=>{const e=n.anMusicPage.querySelector(".aplayer-pic");return!!e&&(btf.setMusicLoading.remove(n.anMusicPage),n.page.classList.remove("music-loader-shadow"),t(e),b(),!0)};if(e){const e=n.anMusicPage.querySelector(".aplayer-pic");t(e)}else{if(n.page.classList.add("music-loader-shadow"),btf.setMusicLoading.add(n.anMusicPage),a())return;const e=new MutationObserver((()=>{a()&&e.disconnect()}));e.observe(n.anMusicPage,{childList:!0,subtree:!0})}},y=()=>{o.getByteFrequencyData(d),n.ctx.clearRect(0,0,n.canvas.width,n.canvas.height);const a=localStorage.getItem("themeColor");g!==a&&(g=a,h=e(btf.map.get(a),t.cache)),p=n.ctx.createLinearGradient(0,0,0,n.canvas.height),p.addColorStop(0,h),n.ctx.shadowBlur=t.visualizer.shadowBlur,n.ctx.shadowColor=h,n.ctx.fillStyle=p;const s=2*c,r=s-1,i=(n.canvas.width-1*r-1)/s,u=n.canvas.width/2,m=n.canvas.height;for(let e=0;e<c;e++){const t=.5*d[e],a=i*(1-t/m),s=u-.5-e*(i+1)-i,o=u+.5+e*(i+1);n.ctx.beginPath(),n.ctx.moveTo(s,m),n.ctx.lineTo(s+i,m),n.ctx.lineTo(s+i-a/2,m-t),n.ctx.lineTo(s+a/2,m-t),n.ctx.closePath(),n.ctx.fill(),n.ctx.beginPath(),n.ctx.moveTo(o,m),n.ctx.lineTo(o+i,m),n.ctx.lineTo(o+i-a/2,m-t),n.ctx.lineTo(o+a/2,m-t),n.ctx.closePath(),n.ctx.fill()}l=requestAnimationFrame(y)},b=()=>{const e=n.anMusicPage.querySelector("meting-js")?.aplayer;if(!e)return;e.volume(u,!0),e.on("loadeddata",(()=>f(!0))),n.canvas.width=Math.min(.95*window.innerWidth,1500);const t=n.anMusicPage.querySelector(".aplayer-pic"),a=t.querySelector(".child")||(()=>{const e=document.createElement("div");return e.className="child",t.appendChild(e),e})();e.on("play",(()=>{var n;t.classList.add("turn-around"),a.style.animationPlayState="running","suspended"===s?.state&&s.resume(),n=e.audio,i||(i=n,r=s.createMediaElementSource(i),r.connect(o),o.connect(s.destination)),y();const l=e.list.audios[e.list.index];"mediaSession"in navigator&&(navigator.mediaSession.metadata=new MediaMetadata({title:l.name,artist:l.artist,album:l.artist,artwork:[{src:l.cover||""}]}))})),e.on("pause",(()=>{t.classList.remove("turn-around"),a.style.animationPlayState="paused",setTimeout((()=>{cancelAnimationFrame(l),n.ctx.clearRect(0,0,n.canvas.width,n.canvas.height)}),1e3)})),(e=>{const t=btf.debounce((t=>{switch(t.code){case"Space":t.preventDefault(),e.toggle();break;case"ArrowRight":t.preventDefault(),e.skipForward();break;case"ArrowLeft":t.preventDefault(),e.skipBack();break;case"ArrowUp":t.preventDefault(),u=Math.min(u+.1,1),e.volume(u,!0);break;case"ArrowDown":t.preventDefault(),u=Math.max(u-.1,0),e.volume(u,!0)}}),200),a=btf.debounce((()=>{const e=document.getElementById("menu-mask");e.style.display="block",e.style.animation="0.5s ease 0s 1 normal none running to_show",document.querySelector(".aplayer.aplayer-withlist .aplayer-list").style.opacity="1"}),300),s=btf.debounce((()=>{document.querySelector(".aplayer-list").classList.remove("aplayer-list-hide")}),300);btf.addEventListenerPjax("click",n.anMusicPage.querySelector(".aplayer-info .aplayer-time .aplayer-icon-menu"),a),btf.addEventListenerPjax("click",n.menuMask,s),btf.addEventListenerPjax("click",n.anMusicPage,(t=>{const{target:n}=t;n.closest("#anMusicBtnGetSong")?btf.debounce(M,300)(e):n.closest("#anMusicRefreshBtn")?btf.debounce(x,300)():n.closest("#anMusicSwitching")&&btf.debounce(E,300)()})),btf.addEventListenerPjax("keydown",document,t),btf.addEventListenerPjax("resize",window,btf.throttle((()=>{n.canvas.width=Math.min(.95*window.innerWidth,1500)}),100))})(e);btf.addGlobalFn("pjaxSendOnce",(()=>{document.querySelectorAll("meting-js").forEach((e=>{try{e.lock=!0,e.aplayer?.pause?.(),e.aplayer?.events?.events&&Object.keys(e.aplayer.events.events).forEach((t=>{e.aplayer.events.events[t]=[]})),setTimeout((()=>{try{e.aplayer?.destroy?.(),e.aplayer=null,e.innerHTML=""}catch(e){console.warn("[MetingJS] 延迟销毁失败:",e)}}),150)}catch(e){console.warn("[MetingJS] 销毁失败:",e)}}))}),"destroyMetingAPlayer"),btf.addGlobalFn("pjaxSendOnce",(()=>{cancelAnimationFrame(l),n.ctx.clearRect(0,0,n.canvas.width,n.canvas.height)}),"musicCanvasDestroy")},v=e=>{for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e},w=e=>`https://meting-js.miraii.cn/api?server=${e.server}&type=${e.type}&id=${e.id}&r=${Math.random()*Date.now()}`,S=async e=>{try{const t=await fetch(e);return t.ok?await t.json():[]}catch(e){return console.error("Fetch songs error:",e),[]}},M=e=>{const t=e.list.audios;if(!t?.length)return;let n=[];try{n=JSON.parse(localStorage.getItem("shuffledPlaylist")||"[]")}catch{}(!n.length||n.length>=t.length)&&(n=v([...Array(t.length).keys()]));const a=n.shift();localStorage.setItem("shuffledPlaylist",JSON.stringify(n)),e.list.switch(a),e.play()},x=async()=>{const e=n.anMusicPage.querySelector("meting-js")?.aplayer;if(!e)return;e.pause(),a=t.defaultMusic,localStorage.setItem("localMusic",JSON.stringify(t.defaultMusic));const s=await S(w(a));s.length&&(e.list.clear(),e.list.add(s))},E=async()=>{const e=n.anMusicPage.querySelector("meting-js")?.aplayer;if(!e)return;e.pause(),localStorage.removeItem("shuffledPlaylist");let s=[];try{s=JSON.parse(localStorage.getItem("shuffledMusicList")||"[]")}catch{}(!s.length||s.length>=m.length)&&(s=v([...Array(m.length).keys()]));let o=s.shift();for(;m[o]?.id===a.id&&s.length;)o=s.shift();localStorage.setItem("shuffledMusicList",JSON.stringify(s)),a=m[o]||t.defaultMusic,localStorage.setItem("localMusic",JSON.stringify(a));const r=await S(w(a));r.length&&(e.list.clear(),e.list.add(r))};(()=>{try{a=JSON.parse(localStorage.getItem("localMusic"))||t.defaultMusic}catch{a=t.defaultMusic,localStorage.removeItem("localMusic")}localStorage.setItem("defaultMusic",JSON.stringify(t.defaultMusic)),localStorage.setItem("localMusic",JSON.stringify(a))})(),(()=>{s=new(window.AudioContext||window.webkitAudioContext),o=s.createAnalyser(),o.fftSize=t.visualizer.fftSize,o.smoothingTimeConstant=t.visualizer.smoothing,c=o.frequencyBinCount,d=new Uint8Array(c);btf.addGlobalFn("pjaxSendOnce",(()=>{s&&(s.close().catch(console.error),s=null,o=null,r=null,i=null)}),"audioContextDestroy")})(),Promise.all([(async()=>{if(!m)try{const e=await fetch("https://cdn.aimiliy.top/npm/json/musicListCache.json");m=e.ok?await e.json():[t.defaultMusic]}catch(e){m=[t.defaultMusic],console.log("Fetch remote musicList error:",e)}})(),new Promise((e=>setTimeout(e,0)))]).then((()=>{f(!1)}))}}})(),a=(()=>{let e=null,t=!1,n=null;const a=()=>{if(e)return;e=new Swiper(".blog-slider",{passiveListeners:!0,spaceBetween:30,effect:"fade",autoplay:!1,loop:!0,delay:5e3,disableOnInteraction:!0,mousewheel:!0,pagination:{el:".blog-slider__pagination",clickable:!0}});const a=document.getElementById("swiper_container");a&&((t=>{const a=btf.throttle((t=>{t.forEach((t=>{e&&(t.isIntersecting?e.autoplay.start():e.autoplay.stop())}))}),200);n=new IntersectionObserver(a,{threshold:.5}),n.observe(t),btf.addEventListenerPjax("mouseenter",t,(()=>{e&&e.autoplay.stop()})),btf.addEventListenerPjax("mouseleave",t,(()=>{btf.runIdle((()=>e&&e.autoplay.start()),500)}))})(a),btf.addGlobalFn("pjaxSendOnce",(()=>{e&&(e.destroy(!0,!0),e=null),t=!1,n&&(n.disconnect(),n=null)}),"swiperModuleDestroy"))};return{init:()=>{if(n&&(n.disconnect(),n=null),e&&(e.destroy(!0,!0),e=null),t)return;document.getElementById("swiper_container")&&a()}}})(),s=(()=>{let t=0,n=0,a=null;let s=null;const o="bbTalkCache";let r=null;const i=()=>{d(),r=setTimeout(i,4e3)},l=()=>{r||i()},c=()=>{r&&(clearTimeout(r),r=null)},d=()=>{a&&(t++,a.style.transition="transform 0.5s  cubic-bezier(0.68, -0.55, 0.27, 1.55)",a.style.transform=`translateY(${32*-t}px)`,t===n&&setTimeout((()=>{a.style.transition="none",a.style.transform="translateY(0)",t=0}),510))};return{init:async()=>{s&&(s.disconnect(),s=null),c(),t=0,n=0,a=null;const r=document.getElementById("bb-talk");if(!r)return;r.replaceChildren();let i=(()=>{try{const e=localStorage.getItem(o);if(!e)return null;const t=JSON.parse(e);if(Date.now()-t.timestamp<36e5)return t.data}catch(e){console.warn("缓存读取失败:",e)}return null})();if(!i)try{const t=await fetch("https://linghua.aimiliy.top/api/bb/list?page=1&size=6");if(!t.ok)throw new Error("网络错误: "+t.status);i=(await t.json()).data.items.map((t=>e.removeAllHtmlTagsNoMark(e.contentFormat(t.content)))),(e=>{try{const t={timestamp:Date.now(),data:e};localStorage.setItem(o,JSON.stringify(t))}catch(e){console.warn("缓存写入失败:",e)}})(i)}catch(e){console.error("获取数据失败:",e),i=["<b>加载失败</b>，请稍后再试~"]}var d;a=document.createElement("div"),a.className="bb-track",a.style.willChange="transform",((e,t)=>{const n=document.createDocumentFragment();e.forEach((e=>{const t=document.createElement("div");t.className="bb-item",t.innerHTML=e,n.appendChild(t)}));const a=n.firstChild?.cloneNode(!0);a&&n.appendChild(a),t.appendChild(n)})(i,a),r.appendChild(a),n=i.length,d=r,s&&s.disconnect(),s=new IntersectionObserver((e=>{e.forEach((e=>{e.isIntersecting?btf.runIdle(l,400):c()}))}),{threshold:.3}),s.observe(d),btf.addGlobalFn("pjaxSendOnce",(()=>{c(),s&&(s.disconnect(),s=null);const e=document.getElementById("bb-talk");e?.replaceChildren()}),"bbTalkElDestroy")}}})(),o=(()=>{let e=null,t=new Set;return{init:(n=".wow")=>{const a=document.querySelectorAll(n),s=(e||(e=new IntersectionObserver((n=>{n.forEach((n=>{const a=n.target;n.isIntersecting&&!a.dataset.revealed&&(a.dataset.revealed="true",e.unobserve(a),t.delete(a),requestAnimationFrame((()=>{a.classList.add("in-view")})))}))}),{threshold:.1,rootMargin:"100px 0px"})),e);a.forEach((e=>{t.has(e)||(s.observe(e),t.add(e))})),btf.addGlobalFn("pjaxSendOnce",(()=>{e&&(e.disconnect(),e=null,t.clear())}))}}})(),r=(()=>{const t=async()=>{const t=new Date,n=new Date(t.setHours(0,0,0,0)),a=new Date(t.getFullYear(),t.getMonth(),t.getDate()-1),s=new Date(t.getFullYear(),t.getMonth(),t.getDate()-1,23,59,59,999),o=new Date(t.getFullYear(),t.getMonth(),1),r=new Date(2024,1,1);r.setHours(0,0,0,0);try{const[t,i,l,c]=await Promise.all([e.fetchUmami(a,s,e.umiToken),e.fetchUmami(n,new Date,e.umiToken),e.fetchUmami(o,new Date,e.umiToken),e.fetchUmami(r,new Date,e.umiToken)]),d=["今日人数","今日访问","昨日人数","昨日访问","本月访问","总访问量"],u=[i.visitors?.value||0,i.pageviews?.value||0,t.visitors?.value||0,t.pageviews?.value||0,l.pageviews?.value||0,c.pageviews?.value||0],m=()=>{d.forEach(((e,t)=>{const n=document.getElementById(e),a=parseFloat(n.textContent.replace(/,/g,""))||0;new CountUp(n,a,u[t],0,2,{useEasing:!0,useGrouping:!0,separator:",",decimal:"."}).start()}))},p=document.querySelector(".about-statistic.author-content-item"),g=new IntersectionObserver(((e,t)=>{e.forEach((e=>{e.isIntersecting&&("function"==typeof CountUp?m():getScript(`${GLOBAL_CONFIG.countUp.js}`).then(m),t.disconnect())}))}),{root:null,rootMargin:"0px",threshold:0});p&&g.observe(p)}catch(e){console.log("获取统计数据失败：",e)}let i=null;const l=()=>{(()=>{const e=document.querySelector("span[data-show]"),t=e?.nextElementSibling||document.querySelector(".first-tips"),n=document.querySelector("span[data-up]");n&&n.removeAttribute("data-up"),e&&(e.removeAttribute("data-show"),e.setAttribute("data-up","")),t&&t.setAttribute("data-show","")})(),i=setTimeout(l,2e3)};i=setTimeout(l,2e3),btf.addGlobalFn("pjaxSendOnce",(()=>{i&&(clearTimeout(i),i=null)}))};return{init:async()=>{await t()}}})(),i={init:()=>{let t=0,n=0,a=[],s=1;const o=document.getElementById("more"),r=document.getElementById("bb_loading");let i=document.getElementById("bb-main");const l=new Masonry(i,{itemSelector:".bb-card",columnWidth:".bb-card",gutter:10,percentPosition:!0});let c=!1;const d=async()=>{if(!c){c=!0,o.style.display="none",r.style.display="block";try{const e=await fetch(`https://linghua.aimiliy.top/api/bb/list?page=${s}&size=12`);if(!e.ok)throw new Error("网络错误: "+e.status);const o=await e.json();t=o.data.total,a=o.data.items,n+=a.length,1===s&&(document.querySelector(".bb-info").innerHTML=`\n                                <svg style="width:1.20em;height:1.20em;top:5px;fill:currentColor;overflow:hidden;position:relative">\n                                    <use xlink:href="#icon-chat"></use>\n                                </svg> 站长的日常分享(${t})\n                            `),s+=1,await u()}catch(e){console.error("获取数据失败:",e),btf.$notify("加载失败","当前网络异常，请稍后重试","error",3e3)}finally{r.style.display="none",n<t&&(o.style.display="block"),c=!1}}},u=()=>new Promise((s=>{let c=0;setTimeout((()=>{r.style.display="none"}),300);const d=()=>{if(c>=a.length)return n<t&&(o.style.display="block"),void s();const r=a[c],u=e.formatDateTime(r.createdAt);r.content=e.contentFormat(r.content);const m=e.removeAllHtmlTags(r.content),p=document.createElement("div");p.className="bb-card",p.style.opacity="0",p.style.transform="translateY(20px)",p.innerHTML=`\n                                    <div class="card-header">\n                                        <div class="avatar">\n                                            <img class="nofancybox" src="${r.author.avatar}">\n                                        </div>\n                                        <div class="bb-info-avatar">\n                                            <span><div class="name">${r.author.nickName}</div><svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" class="is-badge"><path  d="m512 268c0 17.9-4.3 34.5-12.9 49.7s-20.1 27.1-34.6 35.4c.4 2.7.6 6.9.6 12.6 0 27.1-9.1 50.1-27.1 69.1-18.1 19.1-39.9 28.6-65.4 28.6-11.4 0-22.3-2.1-32.6-6.3-8 16.4-19.5 29.6-34.6 39.7-15 10.2-31.5 15.2-49.4 15.2-18.3 0-34.9-4.9-49.7-14.9-14.9-9.9-26.3-23.2-34.3-40-10.3 4.2-21.1 6.3-32.6 6.3-25.5 0-47.4-9.5-65.7-28.6-18.3-19-27.4-42.1-27.4-69.1 0-3 .4-7.2 1.1-12.6-14.5-8.4-26-20.2-34.6-35.4-8.5-15.2-12.8-31.8-12.8-49.7 0-19 4.8-36.5 14.3-52.3s22.3-27.5 38.3-35.1c-4.2-11.4-6.3-22.9-6.3-34.3 0-27 9.1-50.1 27.4-69.1s40.2-28.6 65.7-28.6c11.4 0 22.3 2.1 32.6 6.3 8-16.4 19.5-29.6 34.6-39.7 15-10.1 31.5-15.2 49.4-15.2s34.4 5.1 49.4 15.1c15 10.1 26.6 23.3 34.6 39.7 10.3-4.2 21.1-6.3 32.6-6.3 25.5 0 47.3 9.5 65.4 28.6s27.1 42.1 27.1 69.1c0 12.6-1.9 24-5.7 34.3 16 7.6 28.8 19.3 38.3 35.1 9.5 15.9 14.3 33.4 14.3 52.4zm-266.9 77.1 105.7-158.3c2.7-4.2 3.5-8.8 2.6-13.7-1-4.9-3.5-8.8-7.7-11.4-4.2-2.7-8.8-3.6-13.7-2.9-5 .8-9 3.2-12 7.4l-93.1 140-42.9-42.8c-3.8-3.8-8.2-5.6-13.1-5.4-5 .2-9.3 2-13.1 5.4-3.4 3.4-5.1 7.7-5.1 12.9 0 5.1 1.7 9.4 5.1 12.9l58.9 58.9 2.9 2.3c3.4 2.3 6.9 3.4 10.3 3.4 6.7-.1 11.8-2.9 15.2-8.7z" fill="#1da1f2"></path></svg></span>\n                                            <div class="card-time">${u}</div>\n                                        </div>\n                                    </div>\n                                    <div class="card-content">${r.content}</div>\n                                    <div class="card-footer">\n                                        <div class="card-label" style="background: ${r.tag.bgColor}; color: white;">\n                                            ${r.tag.name}\n                                        </div>\n                                        <div class="bb-fos" onclick="btf.rmf.rightMenuCommentText(&quot;${m}&quot;)">\n                                            <svg style="width:1.60em;height:1.60em;fill:var(--theme-color);overflow:hidden;cursor: pointer;">\n                                                <use xlink:href="#icon-xiaoxi"></use>\n                                            </svg>\n                                        </div>\n                                    </div>\n                                `,i.appendChild(p),imagesLoaded(p,(()=>{l.appended(p),l.layout(),p.style.transition="opacity 0.4s ease, transform 0.4s ease",p.style.opacity="1",p.style.transform="translateY(0)",btf.runIdle((()=>{p.querySelectorAll(".iframe-loader[data-src]").forEach((e=>{if(e.dataset.loaded)return;const t=e.getAttribute("data-src"),n=document.createElement("iframe");n.src=t,n.loading="lazy",n.scrolling="no",n.frameBorder="0",n.framespacing="0",n.allowFullscreen=!0,n.style.cssText="\n      position: absolute; width: 100%; height: 100%; top: 0; left: 0; border-radius: 10px; opacity: 0; transition: opacity 0.3s ease;\n    ",e.appendChild(n),setTimeout((()=>{n.src=t}),0),n.onload=()=>{setTimeout((()=>{const t=e.querySelector(".loading-spinner");t&&t.remove(),n.style.opacity="1",e.dataset.loaded="true"}),50)}}))}),1e3),c++,setTimeout(d,100)}))};d()}));d(),btf.addGlobalFn("pjaxSendOnce",(()=>l.destroy())),o&&btf.addEventListenerPjax("click",o,d)}},l={init:async()=>{await(async()=>{const t=document.querySelector("#statisticW .content");if(!t)return;const n=new Date,a=new Date(n.setHours(0,0,0,0)),s=new Date(n.getFullYear(),n.getMonth(),n.getDate()-1),o=new Date(n.getFullYear(),n.getMonth(),n.getDate()-1,23,59,59,999),r=new Date(n.getFullYear(),n.getMonth(),1);try{const[n,i,l]=await Promise.all([e.fetchUmami(s,o,e.umiToken),e.fetchUmami(a,new Date,e.umiToken),e.fetchUmami(r,new Date,e.umiToken)]),c=["今日人数","昨日人数","今日访问","昨日访问","本月访问"],d=[i.visitors?.value||0,n.visitors?.value||0,i.pageviews?.value||0,n.pageviews?.value||0,l.pageviews?.value||0],u=()=>{c.forEach(((e,t)=>{const n=document.getElementById(e),a=parseFloat(n.textContent.replace(/,/g,""))||0;new CountUp(n,a,d[t],0,2,{useEasing:!0,useGrouping:!0,separator:",",decimal:"."}).start()}))};new IntersectionObserver(((e,t)=>{e.forEach((e=>{e.isIntersecting&&("function"==typeof CountUp?u():getScript(`${GLOBAL_CONFIG.countUp.js}`).then(u),t.disconnect())}))})).observe(t)}catch(e){console.warn("统计数据加载失败",e)}})()}},c=(()=>{const e="https://feed.miraii.cn/feed",t="blog_feed_cache",n=216e5,a=20,s="https://miraii.cn/assets/r1.webp",o=()=>{const e=localStorage.getItem(t);if(!e)return null;const a=JSON.parse(e);return(new Date).getTime()-a.timestamp<n?a:null},r=e=>e?e.replace(/<br\s*\/?>/gi,"\n").trim():"",i=e=>marked.parse(e),l=e=>e.replace(/\[hplayer\][\s\S]*?\[Music\s+server="([^"]+)"\s+id="([^"]+)"\s+type="([^"]+)"\s*\/\][\s\S]*?\[\/hplayer\]/gi,((e,t,n,a)=>`<meting-js id="${n}" server="${t}" type="${a}" mutex="true" preload="auto"></meting-js>`));return{init:()=>{let c=[],d=0,u=!1,m=null,p=!1;const g=document.getElementById("masonry-container"),h=document.getElementById("loading"),f=document.getElementById("no-more"),y=document.getElementById("refresh-btn"),b=document.getElementById("clear-cache-btn"),v=document.getElementById("cache-time"),w=document.getElementById("error-container"),S=document.getElementById("error-message"),M=e=>{if(!e)return;const t=document.getElementById("friend-count"),n=document.getElementById("success-count"),a=document.getElementById("fail-count"),s=document.getElementById("article-count");document.getElementById("update-time").textContent=e.fetchTime;const o={useEasing:!0,useGrouping:!0,separator:",",decimal:"."},r=(e,t)=>{const n=(e=>{const t=e.textContent.replace(/,/g,"");return isNaN(t)||""===t?0:Number(t)})(e);n===t?e.textContent=t.toLocaleString():"function"==typeof CountUp?new CountUp(e,n,t,0,1.2,o).start():getScript(`${GLOBAL_CONFIG.countUp.js}`).then((()=>{new CountUp(e,n,t,0,1.2,o).start()}))};r(t,e.friendCount||0),r(n,e.successCount||0),r(a,e.failCount||0),r(s,e.articleCount||0)},x=async(n=!1)=>{try{if(C(!0),y.disabled=!0,b.disabled=!0,!n){const e=o();if(e)return c=e.items,M(e.meta),void E((()=>{L(e.timestamp),C(!1),y.disabled=!1,b.disabled=!1}))}const a=await fetch(e);if(!a.ok)throw new Error(`API请求失败: ${a.status} ${a.statusText}`);const s=await a.json();if(!s||!Array.isArray(s.items))throw new Error("无效的API响应数据");c=s.items;const r={items:c,meta:{friendCount:s.meta.friend_count||0,successCount:s.meta.success_count||0,failCount:s.meta.fail_count||0,articleCount:s.meta.article_count||0,fetchTime:s.meta.fetch_time||"暂无时间"},timestamp:(new Date).getTime()};localStorage.setItem(t,JSON.stringify(r)),btf.scrollToDest(0,500),d=0,g.innerHTML="",m&&(m.layout(),m.destroy(),m=null),M(r.meta),E((()=>{L(r.timestamp),w.style.display="none",C(!1),y.disabled=!1,b.disabled=!1}))}catch(e){console.error("数据加载失败:",e),w.style.display="block",S.textContent=e.message;const t=o();t?(c=t.items,M(t.meta),E((()=>{L(t.timestamp),C(!1),y.disabled=!1,b.disabled=!1}))):(g.innerHTML="",m&&m.layout(),C(!1),y.disabled=!1,b.disabled=!1)}},E=(e=()=>{})=>{if(0===c.length)return g.innerHTML='<div class="no-more" style="display:block;">没有找到文章数据</div>',f.style.display="none",void e();if(p)return;p=!0;const t=d,n=Math.min(t+a,c.length);let s=t;const o=()=>{if(s>=n)return d=n,f.style.display=d>=c.length?"block":"none",p=!1,void e();const t=c[s],a=I(t);let r=!1;const i=()=>{r||(r=!0,m||(m=new Masonry(g,{itemSelector:".fc-card",columnWidth:".fc-card",percentPosition:!0,gutter:20})),clearTimeout(l),g.appendChild(a),m.appended(a),m.layout(),requestAnimationFrame((()=>{a.style.opacity="1",a.style.transform="translateY(0)",a.style.transition="opacity 0.4s ease, transform 0.4s ease"})),s++,btf.runIdle(o,50))},l=setTimeout(i,1e3);imagesLoaded(a,i)};o()},I=e=>{const t=document.createElement("div");t.className="fc-card",t.style.opacity="0",t.style.transform="translateY(20px)";const n=e.published?new Date(e.published):new Date,a=`${n.getFullYear()}-${(n.getMonth()+1).toString().padStart(2,"0")}-${n.getDate().toString().padStart(2,"0")}`;var o,c;return t.innerHTML=`\n                                <div class="card-header">\n                                    <h3 class="card-title">   \n                                         <a href="${o=e.url,c=e.link,/^https?:\/\//i.test(c)?c:o?(o=o.replace(/\/+$/,""),c.startsWith("/")||(c="/"+c),o+c):c}" target="_blank" rel="noopener noreferrer">\n                                           📝 ${e.title}\n                                         </a>\n                                    </h3>\n                                    <div class="card-author">\n                                        <img src="${e.avatar}" alt="${e.author}" class="avatar" loading="lazy" onerror="this.onerror=null;this.src='${s}';">\n                                        <div>\n                                            <div class="author-name">${e.author}</div>\n                                            <div class="card-date">${a}</div>\n                                        </div>\n                                    </div>\n                                 </div>\n                            <div class="fc-card-content">\n                              ${(e=>{if(!/\[scode|\[collapse|\[hplayer|\[Music/.test(e))return i(r(e));let t=e;return t=t.replace(/\[scode\s+type="([^"]+)"\](.*?)\[\/scode\]/g,((e,t,n)=>`<span class="scode scode-${t}">${n}</span>`)),t=t.replace(/\[collapse\s+status="([^"]+)"\s+title="([^"]+)"\]([\s\S]*?)\[\/collapse\]/g,((e,t,n,a)=>`<details ${"true"===t?"open":""}><summary>${n}</summary><div class="collapse-content">${a.trim()}</div></details>`)),t=t.replace(/<br\s*\/?>/gi,"<br>"),(t.includes("[hplayer]")||t.includes("[Music"))&&(t=l(t)),i(r(t))})(e.content)||"暂无内容"}…\n                            </div>\n                            `,t};let k=0;const T=btf.throttle((()=>{if(p||u)return;const e=document.querySelector("#masonry-container");if(!e)return;const t=document.documentElement.scrollTop||document.body.scrollTop,n=t>k;if(k=t,!n)return;e.getBoundingClientRect().bottom-window.innerHeight<=200&&$()}),150),$=()=>{d>=c.length||u||(u=!0,C(!0),E((()=>{u=!1,C(!1)})))},C=e=>{h.style.display=e?"block":"none"},L=e=>{if(!e)return void(v.textContent="--:--:--");const t=new Date(e+n).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});v.textContent=`${t}`};(async()=>{const e=o();e?(c=e.items,M(e.meta),E((()=>{L(e.timestamp)}))):await x()})(),btf.addEventListenerPjax("scroll",window,T,{passive:!0}),y.addEventListener("click",btf.debounce((()=>{x(!0)}),300)),b.addEventListener("click",btf.debounce((()=>{localStorage.removeItem(t),x(!0)}),300)),btf.addGlobalFn("pjaxSendOnce",(()=>{m&&(m.destroy(),m=null)}),"removeFcirleMasonry")}}})(),d=(()=>{const e=new Date("2023-11-12T00:00:00"),t=e=>e<10?`0${e}`:e,n={days:null,hours:null,minutes:null,seconds:null};let a=null;const s=o=>{(a=>{const s=new Date-e,o={days:Math.floor(s/864e5),hours:t(Math.floor(s/36e5%24)),minutes:t(Math.floor(s/6e4%60)),seconds:t(Math.floor(s/1e3%60))};if(a.days)for(const e in a)a[e]&&n[e]!==o[e]&&(a[e].textContent=o[e],n[e]=o[e])})(o),a=setTimeout((()=>s(o)),1e3)},o=()=>{a&&(clearTimeout(a),a=null)},r=n=>{const r=["days","hours","minutes","seconds"],i=document.getElementById("workboard");if(!i)return;const l=new IntersectionObserver(((i,l)=>{i.forEach((i=>{if(!i.isIntersecting)return void o();const l=btf.throttle((()=>{const o=new Date-e,i=[Math.floor(o/864e5),Math.floor(o/36e5%24),Math.floor(o/6e4%60),Math.floor(o/1e3%60)+2];r.forEach(((e,n)=>{const a=document.getElementById(e),s=parseFloat(a?.textContent.replace(/,/g,""))||0;new CountUp(a,s,i[n],0,2,{useEasing:!0,useGrouping:!0,formattingFn:e=>t(e)}).start()})),(e=>{a||s(e)})(n)}),150);"function"==typeof CountUp?l():getScript(`${GLOBAL_CONFIG.countUp.js}`).then(l)}))}));l.observe(i)};return{init:()=>{r({days:document.getElementById("days"),hours:document.getElementById("hours"),minutes:document.getElementById("minutes"),seconds:document.getElementById("seconds")}),btf.addGlobalFn("pjaxSendOnce",(()=>o()))}}})(),u=[{path:"/personal/about/",modules:[r]},{path:"/personal/bb/",modules:[i]},{path:"/life/music/",modules:[n]},{path:"/social/fcircle/",modules:[c]},{path:"/site/census/",modules:[l]}],m=[a,s,t],p=()=>{const e=window.location.pathname;/^\/(?:page\/\d+\/|)$/.test(window.location.pathname)&&(o.init(),((e,t=100)=>{const n=()=>{const a=e.shift();a&&btf.runIdle((()=>{try{a()}catch(e){console.error("任务执行异常：",e)}n()}),t)};n()})(m.map((e=>e.init())).filter((e=>"function"==typeof e)),300));for(const t of u)if(e.startsWith(t.path)){t.modules.forEach((e=>e.init?.()));break}btf.runIdle((()=>d.init()),300)};p(),btf.addGlobalFn("pjaxComplete",p)}));