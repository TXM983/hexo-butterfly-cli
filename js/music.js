const defaultMusic={id:"7397995017",type:"playlist",server:"tencent"};let localMusic=null;try{localMusic=JSON.parse(localStorage.getItem("localMusic"))||defaultMusic}catch(e){localMusic=defaultMusic,localStorage.removeItem("localMusic"),console.log("Error parsing localMusic from localStorage:",e)}let musicVolume=.8,musicListCache=null;const canvas=document.getElementById("visualizer"),ctx=canvas.getContext("2d"),audioContext=new(window.AudioContext||window.webkitAudioContext),analyser=audioContext.createAnalyser();analyser.fftSize=256,analyser.smoothingTimeConstant=.9;const bufferLength=analyser.frequencyBinCount,dataArray=new Uint8Array(bufferLength);let fftId,sourceNode=null,audioElement=null;const initLocalStorage=()=>{localStorage.getItem("defaultMusic")||localStorage.setItem("defaultMusic",JSON.stringify(defaultMusic)),localStorage.getItem("localMusic")||localStorage.setItem("localMusic",JSON.stringify(localMusic))},loadMusicListCache=async()=>{if(!musicListCache)try{const e=await fetch("https://cdn.aimiliy.top/npm/json/musicListCache.json");musicListCache=e.ok?await e.json():[{id:"7397995017",type:"playlist",server:"tencent"}]}catch(e){musicListCache=[{id:"7397995017",type:"playlist",server:"tencent"}],console.log("fetch remote musicList error:",e)}},musicPlayerModule=(()=>{const e=(e=!0)=>{if("/life/music/"!==window.location.pathname)return;const a=document.getElementById("an_music_bg");if(e){const e=document.querySelector("#anMusic-page .aplayer-pic"),t=e.querySelectorAll("div.child");if(t.length>0)t[0].style.backgroundImage=e.style.backgroundImage;else{const t=document.createElement("div");t.classList.add("child"),t.style.backgroundImage=e.style.backgroundImage,e.appendChild(t)}a.style.backgroundImage=e.style.backgroundImage}else{let e=setInterval((()=>{const n=document.querySelector("#anMusic-page .aplayer-pic");if(n){clearInterval(e);const c=n.querySelectorAll("div.child");if(c.length>0)c[0].style.backgroundImage=n.style.backgroundImage;else{const e=document.createElement("div");e.classList.add("child"),e.style.backgroundImage=n.style.backgroundImage,n.appendChild(e)}a.style.backgroundImage=n.style.backgroundImage,t()}}),100)}},t=()=>{const t=document.getElementById("anMusic-page"),c=t.querySelector(".aplayer-info .aplayer-time .aplayer-icon-menu"),i=t.querySelector("#anMusicBtnGetSong"),o=t.querySelector("#anMusicRefreshBtn"),s=t.querySelector("#anMusicSwitching"),u=document.getElementById("anMusic-page").querySelector("meting-js").aplayer;u.volume(musicVolume,!0),u.on("loadeddata",e),canvas.width=window.innerWidth>1500?1500:.95*window.innerWidth;const h=document.querySelector("#anMusic-page .aplayer-pic"),y=document.querySelector("#anMusic-page .aplayer-pic .child"),p=e=>{y&&(y.style.animationPlayState=e)};u.on("play",(()=>{h.classList.contains("turn-around")||h.classList.add("turn-around"),p("running");const e=u.audio;"suspended"===audioContext.state&&audioContext.resume(),n(e);const t=u.list.audios[u.list.index];navigator.mediaSession.metadata=new MediaMetadata({title:t.name,artist:t.artist,album:t.artist,artwork:[{src:t.cover||""}]})})),u.on("pause",(()=>{h.classList.contains("turn-around")&&h.classList.remove("turn-around"),p("paused"),window.cancelAnimationFrame(fftId),ctx.clearRect(0,0,canvas.width,canvas.height)})),window.addEventListener("resize",a((()=>{canvas.width=window.innerWidth>1500?1500:.95*window.innerWidth}),50)),c.addEventListener("click",l),document.getElementById("menu-mask").addEventListener("click",r),i.addEventListener("click",(()=>d(u))),o.addEventListener("click",m),s.addEventListener("click",g),document.addEventListener("onbeforeunload",(()=>{u&&u.destroy()})),document.addEventListener("keydown",(e=>f(e,u)))},a=(e,t)=>{let a=0;return function(...n){const c=Date.now();c-a>=t&&(a=c,e(...n))}},n=e=>{audioElement||(audioElement=e,sourceNode=audioContext.createMediaElementSource(audioElement),sourceNode.connect(analyser),analyser.connect(audioContext.destination)),s()},c=e=>{const t=e.match(/rgb\((\d+), (\d+), (\d+)\)/);if(!t)throw new Error("Invalid RGB string format");const a=parseInt(t[1],10),n=parseInt(t[2],10),c=parseInt(t[3],10);let i=Math.min(a+40,255),o=Math.min(n+40,255),s=Math.min(c+40,255);return i=i.toString(16).padStart(2,"0"),o=o.toString(16).padStart(2,"0"),s=s.toString(16).padStart(2,"0"),`#${i}${o}${s}`};let i=map.get(localStorage.getItem("themeColor")),o=c(i);const s=()=>{fftId=requestAnimationFrame(s),analyser.getByteFrequencyData(dataArray),ctx.clearRect(0,0,canvas.width,canvas.height),i!==map.get(localStorage.getItem("themeColor"))&&(i=map.get(localStorage.getItem("themeColor")),o=c(i));const e=2*bufferLength,t=e-1,a=(canvas.width-1*t-1)/e,n=canvas.width/2,l=ctx.createLinearGradient(0,0,0,canvas.height);l.addColorStop(0,i),ctx.shadowBlur=15,ctx.shadowColor=o,ctx.fillStyle=l;for(let e=0;e<bufferLength;e++){const t=.5*dataArray[e],c=a*(1-t/canvas.height),i=n-.5-e*(a+1)-a,o=n+.5+e*(a+1);ctx.beginPath(),ctx.moveTo(i,canvas.height),ctx.lineTo(i+a,canvas.height),ctx.lineTo(i+a-c/2,canvas.height-t),ctx.lineTo(i+c/2,canvas.height-t),ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.moveTo(o,canvas.height),ctx.lineTo(o+a,canvas.height),ctx.lineTo(o+a-c/2,canvas.height-t),ctx.lineTo(o+c/2,canvas.height-t),ctx.closePath(),ctx.fill()}},l=()=>{const e=document.getElementById("menu-mask");e.style.display="block",e.style.animation="0.5s ease 0s 1 normal none running to_show",document.querySelector(".aplayer.aplayer-withlist .aplayer-list").style.opacity="1"},r=()=>{"/life/music/"===window.location.pathname&&document.querySelector(".aplayer-list").classList.remove("aplayer-list-hide")},u=e=>{for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}return e},d=e=>{const t=e.list.audios;if(!t||t.length<2)return;let a;try{if(a=JSON.parse(localStorage.getItem("shuffledPlaylist"))||[],!Array.isArray(a))throw new Error("shuffledPlaylist is not a valid array")}catch(e){a=[],console.log("Error parsing shuffledPlaylist from localStorage:",e)}0!==a.length&&a.length!==t.length||(a=u([...Array(t.length).keys()]));const n=a.shift();localStorage.setItem("shuffledPlaylist",JSON.stringify(a)),e.list.switch(n),e.play()},m=async()=>{const e=document.getElementById("anMusic-page").querySelector("meting-js").aplayer;e.seek(0),e.pause(),localMusic=defaultMusic,localStorage.setItem("localMusic",JSON.stringify(defaultMusic));const t=h(localMusic);try{const a=await y(t);a.length>0&&(e.list.clear(),e.list.add(a))}catch(e){console.error("Error changing music list:",e)}},g=async()=>{const e=document.getElementById("anMusic-page").querySelector("meting-js").aplayer;let t;localStorage.removeItem("shuffledPlaylist");try{if(t=JSON.parse(localStorage.getItem("shuffledMusicList"))||[],!Array.isArray(t))throw new Error("shuffledMusicList is not a valid array")}catch(e){t=[],console.log("Error parsing shuffledMusicList from localStorage:",e)}0!==t.length&&t.length!==musicListCache.length||(t=u([...Array(musicListCache.length).keys()])),e.seek(0),e.pause();const a=t.shift();localStorage.setItem("shuffledMusicList",JSON.stringify(t)),localMusic=musicListCache[a],localStorage.setItem("localMusic",JSON.stringify(localMusic));const n=h(localMusic);try{const t=await y(n);t.length>0&&(e.list.clear(),e.list.add(t))}catch(e){console.error("Error changing music list:",e)}},h=e=>`https://twikoo.aimiliy.top/music/api?server=${e.server}&type=${e.type}&id=${e.id}&auth=undefined&r=${Math.random()*Date.now()}`,y=async e=>{try{const t=await fetch(e);return t.ok?await t.json():[]}catch(e){return console.error("Error fetching songs:",e),[]}},f=(e,t)=>{if("/life/music/"===window.location.pathname)switch(e.code){case"Space":e.preventDefault(),t.toggle();break;case"ArrowRight":e.preventDefault(),t.skipForward();break;case"ArrowLeft":e.preventDefault(),t.skipBack();break;case"ArrowUp":musicVolume<=1&&(musicVolume+=.1,t.volume(musicVolume,!0));break;case"ArrowDown":musicVolume>=0&&(musicVolume-=.1,t.volume(musicVolume,!0))}};return{init:async()=>{e(!1)}}})(),init=()=>{if("/life/music/"!==window.location.pathname)return;document.getElementById("anMusic-page-meting").innerHTML='<meting-js id="7397995017" server="tencent" type="playlist" mutex="true" preload="auto" theme="var(--theme-color)" order="list" list-max-height="320px"></meting-js>',musicPlayerModule.init(!1).catch(console.error),initLocalStorage(),loadMusicListCache().then((e=>{}))};init();