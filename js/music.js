(()=>{"use strict";const e={id:"7397995017",type:"playlist",server:"tencent"};let t=null;try{t=JSON.parse(localStorage.getItem("localMusic"))||e}catch(a){t=e,localStorage.removeItem("localMusic"),console.log("Error parsing localMusic from localStorage:",a)}let a=.8,n=null;const o=document.getElementById("visualizer"),r=o.getContext("2d"),i=new(window.AudioContext||window.webkitAudioContext),l=i.createAnalyser();l.fftSize=256,l.smoothingTimeConstant=.9;const s=l.frequencyBinCount,c=new Uint8Array(s);let d,u=null,g=null;const m=(()=>{const m=(e=!0)=>{if("/life/music/"!==window.location.pathname)return;const t=document.getElementById("an_music_bg");if(e){const e=document.querySelector("#anMusic-page .aplayer-pic"),a=e.querySelectorAll("div.child");if(a.length>0)a[0].style.backgroundImage=e.style.backgroundImage;else{const t=document.createElement("div");t.classList.add("child"),t.style.backgroundImage=e.style.backgroundImage,e.appendChild(t)}t.style.backgroundImage=e.style.backgroundImage}else{let e=setInterval((()=>{const a=document.querySelector("#anMusic-page .aplayer-pic");if(a){clearInterval(e);const n=a.querySelectorAll("div.child");if(n.length>0)n[0].style.backgroundImage=a.style.backgroundImage;else{const e=document.createElement("div");e.classList.add("child"),e.style.backgroundImage=a.style.backgroundImage,a.appendChild(e)}t.style.backgroundImage=a.style.backgroundImage,h()}}),100)}},h=()=>{const e=document.getElementById("anMusic-page"),t=e.querySelector(".aplayer-info .aplayer-time .aplayer-icon-menu"),n=e.querySelector("#anMusicBtnGetSong"),l=e.querySelector("#anMusicRefreshBtn"),s=e.querySelector("#anMusicSwitching"),c=document.getElementById("anMusic-page").querySelector("meting-js").aplayer;c.volume(a,!0),c.on("loadeddata",m),o.width=window.innerWidth>1500?1500:.95*window.innerWidth;const u=document.querySelector("#anMusic-page .aplayer-pic"),g=document.querySelector("#anMusic-page .aplayer-pic .child"),h=e=>{g&&(g.style.animationPlayState=e)};c.on("play",(()=>{u.classList.contains("turn-around")||u.classList.add("turn-around"),h("running");const e=c.audio;"suspended"===i.state&&i.resume(),p(e);const t=c.list.audios[c.list.index];navigator.mediaSession.metadata=new MediaMetadata({title:t.name,artist:t.artist,album:t.artist,artwork:[{src:t.cover||""}]})})),c.on("pause",(()=>{u.classList.contains("turn-around")&&u.classList.remove("turn-around"),h("paused"),window.cancelAnimationFrame(d),r.clearRect(0,0,o.width,o.height)})),window.addEventListener("resize",y((()=>{o.width=window.innerWidth>1500?1500:.95*window.innerWidth}),50)),t.addEventListener("click",v),document.getElementById("menu-mask").addEventListener("click",k),n.addEventListener("click",(()=>E(c))),l.addEventListener("click",b),s.addEventListener("click",L),document.addEventListener("onbeforeunload",(()=>{c&&c.destroy()})),document.addEventListener("keydown",(e=>B(e,c)))},y=(e,t)=>{let a=0;return function(...n){const o=Date.now();o-a>=t&&(a=o,e(...n))}},p=e=>{g||(g=e,u=i.createMediaElementSource(g),u.connect(l),l.connect(i.destination)),I()},f=e=>{const t=e.match(/rgb\((\d+), (\d+), (\d+)\)/);if(!t)throw new Error("Invalid RGB string format");const a=parseInt(t[1],10),n=parseInt(t[2],10),o=parseInt(t[3],10);let r=Math.min(a+40,255),i=Math.min(n+40,255),l=Math.min(o+40,255);return r=r.toString(16).padStart(2,"0"),i=i.toString(16).padStart(2,"0"),l=l.toString(16).padStart(2,"0"),`#${r}${i}${l}`};let w=map.get(localStorage.getItem("themeColor")),S=f(w);const I=()=>{d=requestAnimationFrame(I),l.getByteFrequencyData(c),r.clearRect(0,0,o.width,o.height),w!==map.get(localStorage.getItem("themeColor"))&&(w=map.get(localStorage.getItem("themeColor")),S=f(w));const e=2*s,t=e-1,a=(o.width-1*t-1)/e,n=o.width/2,i=r.createLinearGradient(0,0,0,o.height);i.addColorStop(0,w),r.shadowBlur=15,r.shadowColor=S,r.fillStyle=i;for(let e=0;e<s;e++){const t=.5*c[e],i=a*(1-t/o.height),l=n-.5-e*(a+1)-a,s=n+.5+e*(a+1);r.beginPath(),r.moveTo(l,o.height),r.lineTo(l+a,o.height),r.lineTo(l+a-i/2,o.height-t),r.lineTo(l+i/2,o.height-t),r.closePath(),r.fill(),r.beginPath(),r.moveTo(s,o.height),r.lineTo(s+a,o.height),r.lineTo(s+a-i/2,o.height-t),r.lineTo(s+i/2,o.height-t),r.closePath(),r.fill()}},v=()=>{const e=document.getElementById("menu-mask");e.style.display="block",e.style.animation="0.5s ease 0s 1 normal none running to_show",document.querySelector(".aplayer.aplayer-withlist .aplayer-list").style.opacity="1"},k=()=>{"/life/music/"===window.location.pathname&&document.querySelector(".aplayer-list").classList.remove("aplayer-list-hide")},M=e=>{for(let t=e.length-1;t>0;t--){const a=Math.floor(Math.random()*(t+1));[e[t],e[a]]=[e[a],e[t]]}return e},E=e=>{const t=e.list.audios;if(!t||t.length<2)return;let a;try{if(a=JSON.parse(localStorage.getItem("shuffledPlaylist"))||[],!Array.isArray(a))throw new Error("shuffledPlaylist is not a valid array")}catch(e){a=[],console.log("Error parsing shuffledPlaylist from localStorage:",e)}0!==a.length&&a.length!==t.length||(a=M([...Array(t.length).keys()]));const n=a.shift();localStorage.setItem("shuffledPlaylist",JSON.stringify(a)),e.list.switch(n),e.play()},b=async()=>{const a=document.getElementById("anMusic-page").querySelector("meting-js").aplayer;a.seek(0),a.pause(),t=e,localStorage.setItem("localMusic",JSON.stringify(e));const n=q(t);try{const e=await A(n);e.length>0&&(a.list.clear(),a.list.add(e))}catch(e){console.error("Error changing music list:",e)}},L=async()=>{const e=document.getElementById("anMusic-page").querySelector("meting-js").aplayer;let a;localStorage.removeItem("shuffledPlaylist");try{if(a=JSON.parse(localStorage.getItem("shuffledMusicList"))||[],!Array.isArray(a))throw new Error("shuffledMusicList is not a valid array")}catch(e){a=[],console.log("Error parsing shuffledMusicList from localStorage:",e)}0!==a.length&&a.length!==n.length||(a=M([...Array(n.length).keys()])),e.seek(0),e.pause();const o=a.shift();localStorage.setItem("shuffledMusicList",JSON.stringify(a)),t=n[o],localStorage.setItem("localMusic",JSON.stringify(t));const r=q(t);try{const t=await A(r);t.length>0&&(e.list.clear(),e.list.add(t))}catch(e){console.error("Error changing music list:",e)}},q=e=>`https://twikoo.aimiliy.top/music/api?server=${e.server}&type=${e.type}&id=${e.id}&auth=undefined&r=${Math.random()*Date.now()}`,A=async e=>{try{const t=await fetch(e);return t.ok?await t.json():[]}catch(e){return console.error("Error fetching songs:",e),[]}},B=(e,t)=>{if("/life/music/"===window.location.pathname)switch(e.code){case"Space":e.preventDefault(),t.toggle();break;case"ArrowRight":e.preventDefault(),t.skipForward();break;case"ArrowLeft":e.preventDefault(),t.skipBack();break;case"ArrowUp":a<=1&&(a+=.1,t.volume(a,!0));break;case"ArrowDown":a>=0&&(a-=.1,t.volume(a,!0))}};return{init:async()=>{m(!1)}}})();(()=>{if("/life/music/"!==window.location.pathname)return;document.getElementById("anMusic-page-meting").innerHTML='<meting-js id="7397995017" server="tencent" type="playlist" mutex="true" preload="auto" theme="var(--theme-color)" order="list" list-max-height="320px"></meting-js>',m.init(!1).catch(console.error),localStorage.getItem("defaultMusic")||localStorage.setItem("defaultMusic",JSON.stringify(e)),localStorage.getItem("localMusic")||localStorage.setItem("localMusic",JSON.stringify(t)),(async()=>{if(!n)try{const e=await fetch("https://cdn.aimiliy.top/npm/json/musicListCache.json");n=e.ok?await e.json():[{id:"7397995017",type:"playlist",server:"tencent"}]}catch(e){n=[{id:"7397995017",type:"playlist",server:"tencent"}],console.log("fetch remote musicList error:",e)}})().then((e=>{}))})()})();