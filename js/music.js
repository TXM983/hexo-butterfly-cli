var defaultMusic={id:"7397995017",type:"playlist",server:"tencent"},localMusic=JSON.parse(localStorage.getItem("localMusic"))||defaultMusic,musicVolume=.8,musicListCache=null,canvas=document.getElementById("visualizer"),ctx=canvas.getContext("2d"),audioContext=new(window.AudioContext||window.webkitAudioContext),analyser=audioContext.createAnalyser();analyser.fftSize=256;var bufferLength=analyser.frequencyBinCount,dataArray=new Uint8Array(bufferLength);let sourceNode=null,audioElement=null;const initLocalStorage=()=>{localStorage.getItem("defaultMusic")||localStorage.setItem("defaultMusic",JSON.stringify(defaultMusic)),localStorage.getItem("localMusic")||localStorage.setItem("localMusic",JSON.stringify(localMusic))},loadMusicListCache=async()=>{if(!musicListCache)try{const e=await fetch("https://cdn.aimiliy.top/npm/json/musicListCache.json");musicListCache=e.ok?await e.json():[{id:"7397995017",type:"playlist",server:"tencent"}]}catch(e){musicListCache=[{id:"7397995017",type:"playlist",server:"tencent"}]}};var musicPlayerModule=(()=>{const e=(e=!0)=>{if("/life/music/"!==window.location.pathname)return;const a=document.getElementById("an_music_bg");if(e){const e=document.querySelector("#anMusic-page .aplayer-pic");a.style.backgroundImage=e.style.backgroundImage}else{let e=setInterval((()=>{const n=document.querySelector("#anMusic-page .aplayer-pic");n&&(clearInterval(e),a.style.backgroundImage=n.style.backgroundImage,t())}),100)}},t=()=>{const t=document.getElementById("anMusic-page"),i=t.querySelector(".aplayer-info .aplayer-time .aplayer-icon-menu"),u=t.querySelector("#anMusicBtnGetSong"),d=t.querySelector("#anMusicRefreshBtn"),g=t.querySelector("#anMusicSwitching"),h=document.getElementById("anMusic-page").querySelector("meting-js").aplayer;h.audio.crossOrigin="anonymous",h.volume(musicVolume,!0),h.on("loadeddata",e),h.on("play",(()=>{const e=h.audio;e.crossOrigin="anonymous","suspended"===audioContext.state&&audioContext.resume(),n(e)})),window.addEventListener("resize",a((()=>{canvas.width=window.innerWidth>1500?1500:.95*window.innerWidth}),50)),i.addEventListener("click",c),document.getElementById("menu-mask").addEventListener("click",o),u.addEventListener("click",(()=>s(h))),d.addEventListener("click",r),g.addEventListener("click",l),document.addEventListener("onbeforeunload",(()=>{h&&h.destroy()})),document.addEventListener("keydown",(e=>m(e,h)))},a=(e,t)=>{let a=0;return function(...n){const i=Date.now();i-a>=t&&(a=i,e(...n))}},n=e=>{audioElement||(audioElement=e,audioElement.crossOrigin="anonymous",sourceNode=audioContext.createMediaElementSource(audioElement),sourceNode.connect(analyser),analyser.connect(audioContext.destination),i())},i=()=>{requestAnimationFrame(i),analyser.getByteFrequencyData(dataArray),ctx.clearRect(0,0,canvas.width,canvas.height);const e=map.get(localStorage.getItem("themeColor")),t=(e=>{const t=e.match(/rgb\((\d+), (\d+), (\d+)\)/);if(!t)throw new Error("Invalid RGB string format");parseInt(t[1],10),parseInt(t[2],10),parseInt(t[3],10);let a=0,n=255,i=204;return a=a.toString(16).padStart(2,"0"),n=n.toString(16).padStart(2,"0"),i=i.toString(16).padStart(2,"0"),`#${a}${n}${i}`})(e),a=2*bufferLength,n=a-1,c=(canvas.width-1*n-1)/a,o=canvas.width/2,s=ctx.createLinearGradient(0,0,0,canvas.height);s.addColorStop(0,e),ctx.shadowBlur=15,ctx.shadowColor=t,ctx.fillStyle=s;for(let e=0;e<bufferLength;e++){const t=.3*dataArray[e],a=c*(1-t/canvas.height),n=o-.5-e*(c+1)-c,i=o+.5+e*(c+1);ctx.beginPath(),ctx.moveTo(n,canvas.height),ctx.lineTo(n+c,canvas.height),ctx.lineTo(n+c-a/2,canvas.height-t),ctx.lineTo(n+a/2,canvas.height-t),ctx.closePath(),ctx.fill(),ctx.beginPath(),ctx.moveTo(i,canvas.height),ctx.lineTo(i+c,canvas.height),ctx.lineTo(i+c-a/2,canvas.height-t),ctx.lineTo(i+a/2,canvas.height-t),ctx.closePath(),ctx.fill()}},c=()=>{const e=document.getElementById("menu-mask");e.style.display="block",e.style.animation="0.5s ease 0s 1 normal none running to_show",document.querySelector(".aplayer.aplayer-withlist .aplayer-list").style.opacity="1"},o=()=>{"/life/music/"===window.location.pathname&&document.querySelector(".aplayer-list").classList.remove("aplayer-list-hide")},s=e=>{const t=e.list.audios,a=Math.floor(Math.random()*t.length);e.list.switch(a)},r=async()=>{const e=document.getElementById("anMusic-page").querySelector("meting-js").aplayer;localMusic=defaultMusic,localStorage.setItem("localMusic",JSON.stringify(defaultMusic));const t=u(localMusic);try{const a=await d(t);a.length>0&&(e.list.clear(),e.list.add(a))}catch(e){console.error("Error changing music list:",e)}},l=async()=>{const e=document.getElementById("anMusic-page").querySelector("meting-js").aplayer;let t;do{t=musicListCache[Math.floor(Math.random()*musicListCache.length)]}while(JSON.parse(localStorage.getItem("localMusic")).id===t.id);localMusic=t,localStorage.setItem("localMusic",JSON.stringify(t));const a=u(t);try{const t=await d(a);t.length>0&&(e.list.clear(),e.list.add(t))}catch(e){console.error("Error changing music list:",e)}},u=e=>`https://twikoo.aimiliy.top/music/api?server=${e.server}&type=${e.type}&id=${e.id}&auth=undefined&r=${Math.random()*Date.now()}`,d=async e=>{try{const t=await fetch(e);return t.ok?await t.json():[]}catch(e){return console.error("Error fetching songs:",e),[]}},m=(e,t)=>{switch(e.code){case"Space":e.preventDefault(),t.toggle();break;case"ArrowRight":e.preventDefault(),t.skipForward();break;case"ArrowLeft":e.preventDefault(),t.skipBack();break;case"ArrowUp":musicVolume<=1&&(musicVolume+=.1,t.volume(musicVolume,!0));break;case"ArrowDown":musicVolume>=0&&(musicVolume-=.1,t.volume(musicVolume,!0))}};return{init:async()=>{e(!1)}}})();const init=()=>{if("/life/music/"!==window.location.pathname)return;document.getElementById("anMusic-page-meting").innerHTML='<meting-js id="7397995017" server="tencent" type="playlist" mutex="true" preload="auto" theme="var(--theme-color)" order="list" list-max-height="320px"></meting-js>',musicPlayerModule.init(!1).catch(console.error)};document.addEventListener("DOMContentLoaded",(()=>{init(),initLocalStorage(),loadMusicListCache().then((e=>{}))})),document.addEventListener("pjax:complete",(()=>{init(),initLocalStorage(),loadMusicListCache().then((e=>{}))}));